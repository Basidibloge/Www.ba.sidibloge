<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASIDI V6 PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { --red: #e31e24; --bg: #0a0a0a; --card: #161616; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; }
        header { background: #000; padding: 20px; text-align: center; border-bottom: 3px solid var(--red); }
        #main-ui { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .tile { background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 30px 10px; text-align: center; cursor: pointer; }
        .tile i { font-size: 40px; color: var(--red); display: block; margin-bottom: 10px; }
        .page { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 3000; overflow-y: auto; padding-top: 70px; }
        .search-bar { position: fixed; top: 0; width: 100%; background: #111; padding: 10px; display: flex; gap: 10px; z-index: 3100; border-bottom: 1px solid var(--red); }
        .items-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .channel-card { background: var(--card); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #222; }
        #player-page { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 100%; max-height: 100vh; }
        .close-player { position: absolute; top: 20px; right: 20px; z-index: 10000; background: var(--red); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="player-page">
    <button class="close-player" onclick="closeVideo()">✕ إغلاق</button>
    <video id="basidi-video" controls autoplay playsinline></video>
</div>

<header><h2>BASIDI <span style="color:var(--red)">V6</span> PRO</h2></header>

<div id="main-ui">
    <div class="tile" onclick="loadCategory('live')"><i class='bx bx-tv'></i><span>مباشر</span></div>
    <div class="tile" onclick="loadCategory('vod')"><i class='bx bx-film'></i><span>الأفلام</span></div>
</div>

<div id="page-list" class="page">
    <div class="search-bar">
        <button onclick="$('#page-list').hide()" style="background:transparent; color:white; border:none; font-size:24px;"><i class='bx bx-arrow-back'></i></button>
        <span id="title-cat">القائمة</span>
    </div>
    <div id="content-grid" class="items-grid"></div>
</div>

<script>
    const server = { h: "http://bufsetn.live:8080", u: "VaRumDmgRh", p: "hopeful5sex" };
    // استخدام وسيط لتجنب مشكلة الـ CORS والصفحة البيضاء
    const proxy = "https://api.allorigins.win/raw?url=";
    let hls = new Hls();

    async function loadCategory(mode) {
        $('#page-list').show();
        $('#content-grid').html("جاري التحميل...");
        const action = mode === 'live' ? 'get_live_categories' : 'get_vod_categories';
        const targetUrl = `${server.h}/player_api.php?username=${server.u}&password=${server.p}&action=${action}`;
        
        try {
            const res = await fetch(proxy + encodeURIComponent(targetUrl));
            const cats = await res.json();
            $('#content-grid').html(cats.map(c => `
                <div class="channel-card" onclick="loadItems('${c.category_id}', '${mode}')">
                    <i class='bx bx-folder' style="font-size:40px; color:var(--red)"></i>
                    <p>${c.category_name}</p>
                </div>
            `).join(''));
        } catch (e) {
            $('#content-grid').html("خطأ في الاتصال. جرب تحديث الصفحة.");
        }
    }

    async function loadItems(catId, mode) {
        $('#content-grid').html("جاري جلب القنوات...");
        const action = mode === 'live' ? 'get_live_streams' : 'get_vod_streams';
        const targetUrl = `${server.h}/player_api.php?username=${server.u}&password=${server.p}&action=${action}&category_id=${catId}`;
        
        const res = await fetch(proxy + encodeURIComponent(targetUrl));
        const data = await res.json();
        
        $('#content-grid').html(data.map(i => `
            <div class="channel-card">
                <img src="${i.stream_icon || ''}" width="100%" onerror="this.src='https://via.placeholder.com/100'">
                <p style="font-size:12px;">${i.name}</p>
                <button onclick="openVideo('${i.stream_id}', '${mode}')" style="background:var(--red); color:white; border:none; width:100%; padding:5px; border-radius:5px;">تشغيل</button>
            </div>
        `).join(''));
    }

    function openVideo(id, mode) {
        $('#player-page').css('display', 'flex');
        const video = document.getElementById('basidi-video');
        let url = mode === 'live' ? `${server.h}/live/${server.u}/${server.p}/${id}.ts` : `${server.h}/movie/${server.u}/${server.p}/${id}.mp4`;

        if (Hls.isSupported()) {
            hls.destroy();
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = url;
            video.play();
        }
    }

    function closeVideo() {
        document.getElementById('basidi-video').pause();
        $('#player-page').hide();
    }
</script>
</body>
</html>
